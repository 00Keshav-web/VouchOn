<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Dashboard - VouchOn</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; background: #eae2b7; margin: 20px; color: #003049; }
    h1 { color: #d62828; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    th, td { border: 1px solid #fcbf49; padding: 8px; text-align: left; }
    th { background-color: #f77f00; color: white; }
    button { background-color: #d62828; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; margin-right: 5px; }
    button:disabled { background-color: #ccc; cursor: not-allowed; }
    .proof-img, .proof-video { max-width: 200px; display: block; margin-top: 5px; }

    /* Flash & Cashback Deals Layout */
    #flashDealsList, #cashbackList {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-top: 15px;
    }

    .deal-card {
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 10px;
      padding: 12px;
      width: 220px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      text-align: center;
    }
    .deal-card img {
      width: 100%;
      height: 140px;
      object-fit: cover;
      border-radius: 6px;
    }
    .deal-card h3 { margin: 8px 0 4px; font-size: 16px; color: #003049; }
    .deal-card p { font-size: 14px; margin: 2px 0; }
  </style>
</head>
<body>
  <h1>Admin Dashboard</h1>

   <!-- ✅ FLASH DEALS MANAGER -->
   <h2>Manage Flash Deals</h2>
   <form id="flashDealForm">
     <input type="hidden" id="flashDealId"> <!-- for editing -->
     <label>Title <input type="text" id="dealTitle" required></label>
     <label>Merchant <input type="text" id="dealMerchant"></label>
     <label>Image URL <input type="url" id="dealImage"></label>
     <label>Starting From Price (₹) <input type="number" id="dealStartingPrice"></label>
     <label>Code <input type="text" id="dealTag"></label>
     <label>Affiliate Link <input type="url" id="dealLink" required></label>
     <label>Expires At <input type="datetime-local" id="dealExpiry" required></label>
     <button type="submit" id="flashSubmitBtn">Add Flash Deal</button>
   </form>
   <div id="flashDealsList">Loading flash deals…</div>
 
   <!-- ✅ CASHBACK DEALS MANAGER -->
   <h2>Manage Cashback Deals</h2>
   <form id="cashbackForm">
     <input type="hidden" id="cashbackDealId"> <!-- for editing -->
     <label>Brand <input type="text" id="cbBrand" required></label>
     <label>Title <input type="text" id="cbTitle" required></label>
     <label>Starting From <input type="text" id="cbCashback" placeholder="e.g. 10% or ₹500"></label>
     <label>Tracking Link <input type="url" id="cbLink" required></label>
     <label>Image URL <input type="url" id="cbImage"></label>
     <label>Expiry (optional) <input type="date" id="cbExpiry"></label>
     <label>Code (optional) <input type="text" id="cbCode"></label>
     <label>Top Deals</label><input type="checkbox" id="cbCheck">
     <button type="submit" id="cashbackSubmitBtn">Add Deal</button>
   </form>
   <div id="cashbackList">Loading cashback deals…</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-app.js";
    import { getDatabase, ref, get, update, onValue, push, remove, set } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAWYBe4SSraagPk2piNq2f53l07Bb6xo9s",
      authDomain: "vouchon-c0b55.firebaseapp.com",
      databaseURL: "https://vouchon-c0b55-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "vouchon-c0b55",
      storageBucket: "vouchon-c0b55",
      messagingSenderId: "882090900584",
      appId: "1:882090900584:web:cd6310c625cc98a477cfdd"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth();

    // ✅ Admins
    const adminUids = ['XLYCuV6kDqhQC4mzicl5544xsOx1', 'ADMIN_UID_2'];
    function isAdmin(user) {
      return user && adminUids.includes(user.uid);
    }

    // ----------------- FLASH DEALS -----------------
    const flashDealForm = document.getElementById("flashDealForm");
    const flashDealsList = document.getElementById("flashDealsList");
    const flashSubmitBtn = document.getElementById("flashSubmitBtn");
    const flashDealId = document.getElementById("flashDealId");

    flashDealForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const deal = {
        title: document.getElementById("dealTitle").value,
        merchant: document.getElementById("dealMerchant").value,
        image: document.getElementById("dealImage").value,
        startingPrice: Number(document.getElementById("dealStartingPrice").value),
        code: document.getElementById("dealTag").value,
        link: document.getElementById("dealLink").value,
        expiry: new Date(document.getElementById("dealExpiry").value).getTime(),
        createdAt: Date.now()
      };

      if (flashDealId.value) {
        // update
        await update(ref(db, "flashDeals/" + flashDealId.value), deal);
        alert("Flash Deal Updated ✅");
        flashSubmitBtn.textContent = "Add Flash Deal";
      } else {
        // add new
        await push(ref(db, "flashDeals"), deal);
        alert("Flash Deal Added ✅");
      }
      flashDealForm.reset();
      flashDealId.value = "";
    });

    function loadFlashDeals() {
      onValue(ref(db, "flashDeals"), (snapshot) => {
        if (!snapshot.exists()) {
          flashDealsList.innerHTML = "<p>No flash deals yet.</p>";
          return;
        }
        flashDealsList.innerHTML = "";
        snapshot.forEach(dealSnap => {
          const deal = dealSnap.val();
          const dealId = dealSnap.key;

          flashDealsList.innerHTML += `
            <div class="deal-card">
              <img src="${deal.image || 'https://via.placeholder.com/80'}" alt="${deal.title}">
              <h3>${deal.title}</h3>
              <p>Merchant: ${deal.merchant || "N/A"}</p>
              <p>Starting from <b>₹${deal.startingPrice || 0}</b> ${deal.code ? `(${deal.code})` : ''}</p>
              <p>Expires: ${new Date(deal.expiry).toLocaleString()}</p>
              <button onclick="editFlashDeal('${dealId}')">Edit ✏️</button>
              <button onclick="deleteDeal('${dealId}')">Delete ❌</button>
            </div>
          `;
        });
      });
    }

    window.editFlashDeal = async (dealId) => {
      const snap = await get(ref(db, "flashDeals/" + dealId));
      if (!snap.exists()) return;
      const deal = snap.val();

      flashDealId.value = dealId;
      document.getElementById("dealTitle").value = deal.title;
      document.getElementById("dealMerchant").value = deal.merchant;
      document.getElementById("dealImage").value = deal.image;
      document.getElementById("dealStartingPrice").value = deal.startingPrice;
      document.getElementById("dealTag").value = deal.code;
      document.getElementById("dealLink").value = deal.link;
      document.getElementById("dealExpiry").value = new Date(deal.expiry).toISOString().slice(0,16);
      flashSubmitBtn.textContent = "Update Flash Deal";
    };

    window.deleteDeal = async (dealId) => {
      if (confirm("Delete this deal?")) {
        await remove(ref(db, "flashDeals/" + dealId));
        alert("Deal deleted ✅");
      }
    };

    // ----------------- CASHBACK DEALS -----------------
    const cashbackForm = document.getElementById("cashbackForm");
    const cashbackList = document.getElementById("cashbackList");
    const cashbackSubmitBtn = document.getElementById("cashbackSubmitBtn");
    const cashbackDealId = document.getElementById("cashbackDealId");

    cashbackForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const deal = {
        brand: document.getElementById("cbBrand").value,
        title: document.getElementById("cbTitle").value,
        cashback: document.getElementById("cbCashback").value,
        trackingUrl: document.getElementById("cbLink").value,
        image: document.getElementById("cbImage").value,
        createdAt: Date.now(),
        clicks: 0,
        code: document.getElementById("cbCode").value,
        topDeals: document.getElementById("cbCheck").checked
      };

      const expiryVal = document.getElementById("cbExpiry").value;
      if (expiryVal) deal.expiresAt = new Date(expiryVal).getTime();

      if (cashbackDealId.value) {
        await update(ref(db, "cashbackDeals/" + cashbackDealId.value), deal);
        alert("Cashback Deal Updated ✅");
        cashbackSubmitBtn.textContent = "Add Deal";
      } else {
        await push(ref(db, "cashbackDeals"), deal);
        alert("Cashback Deal Added ✅");
      }
      cashbackForm.reset();
      cashbackDealId.value = "";
    });

    function loadCashbackDeals() {
      onValue(ref(db, "cashbackDeals"), (snapshot) => {
        if (!snapshot.exists()) {
          cashbackList.innerHTML = "<p>No cashback deals yet.</p>";
          return;
        }
        cashbackList.innerHTML = "";
        snapshot.forEach(dealSnap => {
          const deal = dealSnap.val();
          const dealId = dealSnap.key;

          cashbackList.innerHTML += `
            <div class="deal-card">
              <img src="${deal.image || 'https://via.placeholder.com/200'}" alt="${deal.brand}">
              <h3>${deal.title}</h3>
              <p><b>Brand:</b> ${deal.brand}</p>
              <p><b>Cashback:</b> ${deal.cashback || "N/A"}</p>
              <p><b>Link:</b> <a href="${deal.trackingUrl}" target="_blank">Open</a></p>
              ${deal.expiresAt ? `<p>Expires: ${new Date(deal.expiresAt).toLocaleDateString()}</p>` : "<p>No Expiry</p>"}
              ${deal.code ? `<p>Code: ${deal.code}</p>` : ""}
              <button onclick="editCashback('${dealId}')">Edit ✏️</button>
              <button onclick="deleteCashback('${dealId}')">Delete ❌</button>
            </div>
          `;
        });
      });
    }

    window.editCashback = async (dealId) => {
      const snap = await get(ref(db, "cashbackDeals/" + dealId));
      if (!snap.exists()) return;
      const deal = snap.val();

      cashbackDealId.value = dealId;
      document.getElementById("cbBrand").value = deal.brand;
      document.getElementById("cbTitle").value = deal.title;
      document.getElementById("cbCashback").value = deal.cashback;
      document.getElementById("cbLink").value = deal.trackingUrl;
      document.getElementById("cbImage").value = deal.image;
      document.getElementById("cbCode").value = deal.code || "";
      document.getElementById("cbCheck").checked = !!deal.topDeals;
      if (deal.expiresAt) {
        document.getElementById("cbExpiry").value = new Date(deal.expiresAt).toISOString().slice(0,10);
      }
      cashbackSubmitBtn.textContent = "Update Deal";
    };

    window.deleteCashback = async (dealId) => {
      if (confirm("Delete this cashback deal?")) {
        await remove(ref(db, "cashbackDeals/" + dealId));
        alert("Cashback deal deleted ✅");
      }
    };

    // ----------------- AUTH -----------------
    onAuthStateChanged(auth, (user) => {
      if (!isAdmin(user)) {
        alert('Access denied. Admins only.');
        window.location.href = '/';
        return;
      }
      loadFlashDeals();
      loadCashbackDeals();
    });
  </script>
</body>
</html>
