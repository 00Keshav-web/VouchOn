<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin - Verify Vouchers</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: Arial, sans-serif; background: #eae2b7; padding: 20px; }
    h1 { color: #003049; }
    .voucher { background: white; margin-bottom: 15px; padding: 15px; border-radius: 8px; border-left: 5px solid #f77f00; }
    .voucher h3 { margin: 0; color: #d62828; }
    .btn-verify, .btn-reject {
      padding: 8px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 10px;
      margin-right: 10px;
      font-weight: bold;
    }
    .btn-verify { background: #003049; color: white; }
    .btn-reject { background: #d62828; color: white; }
    iframe, img { max-width: 100%; margin-top: 10px; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <h1>üõ†Ô∏è Admin Panel ‚Äì Verify Vouchers</h1>
  <div id="voucher-list">Loading...</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import { getDatabase, ref, get, set, update, remove } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAWYBe4SSraagPk2piNq2f53l07Bb6xo9s",
      authDomain: "vouchon-c0b55.firebaseapp.com",
      databaseURL: "https://vouchon-c0b55-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "vouchon-c0b55",
      storageBucket: "vouchon-c0b55",
      messagingSenderId: "882090900584",
      appId: "1:882090900584:web:cd6310c625cc98a477cfdd"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    const voucherList = document.getElementById("voucher-list");

    onAuthStateChanged(auth, async (user) => {
      if (!user) return location.href = "login.html";

      const adminEmail = "agarwalkeshav1208@gmail.com"; // Replace with your admin email
      if (user.email !== adminEmail) {
        alert("Access denied. Admin only.");
        location.href = "index.html";
        return;
      }

      const listedSnap = await get(ref(db, "listed"));
      if (!listedSnap.exists()) {
        voucherList.innerHTML = "<p>No vouchers found.</p>";
        return;
      }

      const allListed = listedSnap.val();
      let found = false;
      voucherList.innerHTML = "";

      for (const uid in allListed) {
        const userVouchers = allListed[uid];

        for (const vid in userVouchers) {
          const v = userVouchers[vid];
          if (v.verified === true) continue;

          found = true;
          const div = document.createElement("div");
          div.className = "voucher";
          div.innerHTML = `
            <h3>${v.name}</h3>
            <p><strong>Price:</strong> ‚Çπ${v.price}</p>
            <p><strong>Brand:</strong> ${v.brand}</p>
            <p><strong>Expiry:</strong> ${v.expiryDate}</p>
            <p><strong>Category:</strong> ${v.category}</p>
            <p><strong>Code:</strong> ${v.code}</p>
            <p><strong>Conditions:</strong> ${v.conditions}</p>
            <p><strong>Proof:</strong> <a href="${v.proof}" target="_blank" rel="noopener">View Proof</a></p>
            <p><strong>Seller Confirmation:</strong> ${v.sellerConfirmation}</p>
            ${v.featured ? `<p style="color:#d62828;"><strong>üåü Featured Listing</strong></p>` : ""}
            <button class="btn-verify" data-uid="${uid}" data-id="${vid}">‚úÖ Verify & Approve</button>
            <button class="btn-reject" data-uid="${uid}" data-id="${vid}">‚ùå Reject</button>
          `;

          // Verify button handler
          div.querySelector(".btn-verify").onclick = async (e) => {
            const uid = e.target.getAttribute("data-uid");
            const id = e.target.getAttribute("data-id");

            await update(ref(db, `listed/${uid}/${id}`), { verified: true });
            await set(ref(db, `categories/${v.category}/${id}`), { ...v, verified: true });
            if (v.featured) {
              await set(ref(db, `featured/${uid}/${id}`), { ...v, verified: true });
            }
            alert(`‚úÖ "${v.name}" verified`);
            div.remove();
          };

          // Reject button handler
          div.querySelector(".btn-reject").onclick = async (e) => {
            const uid = e.target.getAttribute("data-uid");
            const id = e.target.getAttribute("data-id");
            const reason = prompt(`‚ùå Please enter a reason for rejecting "${v.name}":`);

            if (!reason) return alert("Rejection reason is required.");

            if (!confirm(`Are you sure you want to reject "${v.name}"?`)) return;

            const rejectedVoucher = {
              ...v,
              reason,
              rejectedAt: Date.now()
            };

            await set(ref(db, `rejected/${uid}/${id}`), rejectedVoucher);

            await remove(ref(db, `listed/${uid}/${id}`));
            
            alert(`‚ùå "${v.name}" rejected and saved with reason.`);
            div.remove();
          };

          voucherList.appendChild(div);
        }
      }

      if (!found) voucherList.innerHTML = "<p>No unverified vouchers available.</p>";
    });
  </script>
</body>
</html>
