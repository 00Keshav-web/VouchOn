<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Travel Vouchers - VouchOn</title>
  <link rel="stylesheet" href="style.css" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="logo-container">
      <img src="vouchon-logo.png" alt="VouchOn Logo" class="logo" />
      <h1 class="site-title">VouchOn</h1>
    </div>
    <nav class="nav">
      <a href="index.html" class="nav-link">Home</a>
      <a href="cart.html" class="nav-link">Cart üõí</a>
      <span id="user-auth"></span>
    </nav>
  </header>

      <section id="filters" class="filter-bar">
        <input type="text" id="searchInput" placeholder="Search by Offer Name or Brand" />
        <input type="number" id="minPrice" placeholder="Min Price" />
        <input type="number" id="maxPrice" placeholder="Max Price" />
        <button onclick="applyFilters()">Apply Filters</button>
        <button onclick="clearFilters()">Clear</button>
      </section>
      
      <div id="voucherList"></div>
  

      <!-- Travel Vouchers -->
      <main class="voucher-section">
        <h2 class="section-title">Travel Vouchers ‚úàÔ∏è</h2>
        <div class="voucher-card voucher-grid" id="voucher-grid"></div>
      </main>

  <!-- Firebase & Script -->
      <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
        import { getDatabase, ref, get, push, query, orderByChild } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";

        const firebaseConfig = {
          apiKey: "AIzaSyAWYBe4SSraagPk2piNq2f53l07Bb6xo9s",
          authDomain: "vouchon-c0b55.firebaseapp.com",
          databaseURL: "https://vouchon-c0b55-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "vouchon-c0b55",
          appId: "1:882090900584:web:cd6310c625cc98a477cfdd"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const voucherGrid = document.getElementById("voucher-grid");
        const authSpan = document.getElementById("user-auth");
        const category = "Travel";
        const catRef = ref(db, `categories/${category}`);
        let currentUser = null;

        function getTemplateId(brand, name) {
          return `${brand.trim().toLowerCase()}-${name.trim().toLowerCase()}`.replace(/[^a-z0-9]+/g, "-");
        }

        async function loadRatingsAndReviews(templateId, container) {
          const snap = await get(ref(db, `reviews/${templateId}`));
          if (!snap.exists()) {
            container.innerHTML = "<em>No ratings yet</em>";
            return;
          }
          const reviews = Object.values(snap.val());
          const avg = (reviews.reduce((sum, r) => sum + r.rating, 0) / reviews.length).toFixed(1);
          const recent = reviews.slice(-2).reverse();

          let html = `<p>‚≠ê Average Rating: ${avg} / 5 (${reviews.length} reviews)</p>`;
          recent.forEach(r => {
            html += `<p>‚≠ê ${r.rating} - ${r.comment || "No comment"}<br><small>- ${r.name || "User"}</small></p>`;
          });

          container.innerHTML = html;
        }

        // Handle auth state
        onAuthStateChanged(auth, user => {
          currentUser = user;
          authSpan.innerHTML = user
            ? `<a href="profile.html" class="nav-link">Profile üë§</a>`
            : `<a href="login.html" class="nav-link">Login üîê</a>`;

            applyFilters();
        });

          // Filter logic
          window.applyFilters = function () {
            const searchText = document.getElementById("searchInput").value.toLowerCase();
            const minPrice = parseInt(document.getElementById("minPrice").value);
            const maxPrice = parseInt(document.getElementById("maxPrice").value);

            get(catRef).then(snapshot => {
              if (snapshot.exists()) {
                voucherGrid.innerHTML = "";
                const data = snapshot.val();
                const now = new Date();

                Object.keys(data).forEach(id => {
                  const v = data[id];
                  if (v.verified !== true) return;

                  const expiry = new Date(v.expiryDate);
                  if(expiry < now) return;

                  const nameBrandMatch = v.name.toLowerCase().includes(searchText) || v.brand.toLowerCase().includes(searchText);

                  const priceMatch = (!minPrice || v.price >= minPrice) && (!maxPrice || v.price <= maxPrice);

                  if (nameBrandMatch && priceMatch) {
                    const div = document.createElement("div");
                    const templateId = getTemplateId(v.brand, v.name);
                    div.className = "voucher";
                    div.innerHTML = `
                    <h3>${v.name}</h3>
                    <p><strong>Brand:</strong> ${v.brand}</p>
                    <p><strong>Price:</strong> ‚Çπ${v.price}</p>
                    <p><strong>Expires:</strong> ${v.expiryDate}</p>
                    <p><strong>Conditions:</strong> ${v.conditions || "None"}</p>
                    <p><strong>Code:</strong> XXXX-XXXX-XXXX</p>
                    <button class="buy-btn">Add to Cart</button>
                    <div class="rating-reviews" id="rating-reviews-${templateId}">Loading ratings...</div>

                    `;
                    
                    const btn = div.querySelector("button");
                    btn.addEventListener("click", () => {
                      if (!currentUser) {
                        alert("Please login to add to cart.");
                        window.location.href = "login.html";
                        return;
                      }

                      const cartRef = ref(db, `carts/${currentUser.uid}`);
                      push(cartRef, {
                        name: v.name,
                        price: v.price,
                        expiryDate: v.expiryDate,
                        brand: v.brand,
                        conditions: v.conditions,
                        category: category,
                        code: v.code,
                        featured: v.featured,
                        key: id,
                        seller: v.seller || "unknown"
                      }).then(() => {
                        alert(`${v.name} added to cart.`);
                      }).catch(err => {
                        alert("Failed to add to cart.");
                        console.error(err);
                      });
                    });

                    voucherGrid.appendChild(div);

                    loadRatingsAndReviews(templateId, div.querySelector(`#rating-reviews-${templateId}`));
                  }
                });
              } else {
                voucherGrid.innerHTML = "<p>No vouchers in this category yet.</p>";
              }
            }).catch(err => {
              voucherGrid.innerHTML = "<p>Error loading vouchers.</p>";
              console.error("Error fetching vouchers:", err);
            });
          }

          window.clearFilters = function () {
            document.getElementById("searchInput").value = "";
            document.getElementById("minPrice").value = "";
            document.getElementById("maxPrice").value = "";
            applyFilters();
          }
      </script>
</body>
</html>
