<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Cart - VouchOn</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header style="display:flex; justify-content: space-between; align-items: center; background: #003049; padding: 10px; color: white;">
    <button onclick="history.back()" class="buy-btn" style="background: #f77f00; border: none; padding: 8px; border-radius: 5px;">‚¨Ö Back</button>
    <h1>Cart üõí</h1>
    <div>
      <a href="index.html"><button class="buy-btn" style="margin-right: 5px; background-color: #f77f00; border: none; padding: 8px;">üè† Home</button></a>
      <a href="profile.html"><button class="buy-btn" style="background-color: #f77f00 ; border: none; padding: 8px;">üë§ Profile</button></a>
    </div>
  </header>

  <main style="padding: 20px;">
    <ul id="cart-list" style="list-style: none; padding: 0;"></ul>
    <h3>Total: ‚Çπ<span id="cart-total">0</span></h3>
    <button class="buy-btn" id="buy-all" style="margin-top: 20px;
    border: none; padding: 10px; background-color: #d62828; color: white;font-size:13px;">Buy All</button>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import { getDatabase, ref, get, remove, set } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAWYBe4SSraagPk2piNq2f53l07Bb6xo9s",
      authDomain: "vouchon-c0b55.firebaseapp.com",
      databaseURL: "https://vouchon-c0b55-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "vouchon-c0b55",
      appId: "1:882090900584:web:cd6310c625cc98a477cfdd"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    const cartList = document.getElementById("cart-list");
    const totalEl = document.getElementById("cart-total");
    const buyAllBtn = document.getElementById("buy-all");

    let cartItems = [];

    onAuthStateChanged(auth, async (user) => {
      if (!user) return location.href = "login.html";

      const cartRef = ref(db, `carts/${user.uid}`);
      const snapshot = await get(cartRef);
      if (!snapshot.exists()) {
        cartList.innerHTML = "<p>Your cart is empty.</p>";
        cartList.style="font-size:40px; font-weight:bold; margin-bottom: 20px;";
        return;
      }

      const cart = snapshot.val();
      let total = 0;
      cartList.innerHTML = "";
      cartItems = [];

      Object.entries(cart).forEach(([key, voucher]) => {
        total += parseFloat(voucher.price);
        cartItems.push({ ...voucher, key });

        const li = document.createElement("li");
        li.innerHTML = `
          <div style="border:1px solid #ccc; padding:10px; margin-bottom:10px;">
            <h4>${voucher.name}</h4>
            <p>Brand: ${voucher.brand}</p>
            <p>Price: ‚Çπ${voucher.price}</p>
            <p>Expiry Date: ${voucher.expiryDate} <p>
            <p>Condition: ${voucher.conditions} </p>
            <button class="remove" data-key="${key}">Remove</button>
          </div>
        `;
        cartList.appendChild(li);
      });

      totalEl.textContent = total.toFixed(2);

      document.querySelectorAll(".remove").forEach(btn => {
        btn.addEventListener("click", async () => {
          const key = btn.dataset.key;
          await remove(ref(db, `carts/${user.uid}/${key}`));
          location.reload();
        });
      });

      buyAllBtn.addEventListener("click", async () => {
        // Save to sessionStorage and redirect to billing
        sessionStorage.setItem("billingItems", JSON.stringify(cartItems));
        sessionStorage.setItem("totalAmount", total.toFixed(2));
        window.location.href = "billing.html";
      });
    });
  </script>
</body>
</html>
